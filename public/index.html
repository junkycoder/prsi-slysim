<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pr≈°√≠, sly≈°√≠m!</title>
  <meta name="description"
    content="Pr≈°√≠, sly≈°√≠m! - Online hra pr≈°√≠ pro v√≠ce hr√°ƒç≈Ø, vytvo≈ôen√° prim√°rnƒõ pro u≈æivatele se zrakov√Ωm handicapem.">
  <meta property="og:title" content="Zahraje≈° si pr≈°√≠?">
  <meta property="og:site_name" content="Pr≈°√≠, sly≈°√≠m!">
  <meta property="og:url" content="https://prsislysim.cz/">
  <meta property="og:description"
    content="Online hra pr≈°√≠ pro v√≠ce hr√°ƒç≈Ø, vytvo≈ôen√° prim√°rnƒõ pro u≈æivatele se zrakov√Ωm handicapem.">
  <meta property="og:type" content="website">
  <!-- <meta property="og:image" content=""> -->
  <style>
    [aria-hidden="true"] {
      display: none;
    }
  </style>
  <link rel="stylesheet" href="/styles.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-970323658"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'AW-970323658');
  </script>
</head>

<body>
  <div class="js-header">
    <header>
      <h1>Pr≈°√≠ sly≈°im!</h1>
      <p>Online hra pr≈°√≠ pro v√≠ce hr√°ƒç≈Ø, vytvo≈ôen√° prim√°rnƒõ pro u≈æivatele se zrakov√Ωm handicapem.</p>
    </header>
  </div>
  <div class="los-alertos"></div>
  <style>
    .los-alertos {
      position: fixed;
      top: 20px;
      left: 24px;
      right: 24px;
      z-index: 420;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .los-alertos__alerto {
      border-radius: 1px;
      padding: 14px;
      transition: opacity 200ms ease-in-out;
      opacity: 0;
      background-color: white;
      color: black;
      border: 5px solid black;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
    }

    @media (prefers-color-scheme: dark) {
      .los-alertos__alerto {
        background-color: black;
        color: white;
        border-color: white;
      }
    }

    .los-alertos__alerto--show {
      opacity: 1;
    }
  </style>
  <script>
    window.alerto = function alerto(message) {
      const container = document.querySelector(".los-alertos");
      const time = Date.now();
      container.insertAdjacentHTML("afterbegin", `
        <div data-time="${time}" class="los-alertos__alerto" role="alert">
          ${message}
        </div>
      `);
      const element = container.querySelector(`.los-alertos__alerto[data-time="${time}"]`);
      const doRemove = () => {
        element.classList.remove("los-alertos__alerto--show");
        setInterval(() => {
          element.setAttribute("aria-hidden", "true");
          element.remove();
        }, 500);
      }
      element.addEventListener("click", doRemove);
      setTimeout(doRemove, 4000);
      setTimeout(() => {
        element.classList.add("los-alertos__alerto--show");
      }, 200);
    }
  </script>
  <div class="js-content">
    <main>
      <h2>Klasick√© pr≈°√≠</h2>
      <p>
        <em>Pr≈°√≠, sly≈°im!</em> v√°m zprost≈ôedkuje z√°≈æitek z hran√≠ bƒõ≈æn√© karetn√≠ hry
        <a href="https://cs.wikipedia.org/wiki/Pr%C5%A1%C3%AD" title="Wikipedie">pr≈°√≠</a>
        za pou≈æit√≠ obyƒçejn√©ho textu a akustick√Ωch efekt≈Ø.
      </p>
      <h2>Zvukov√© efekty</h2>
      <p>Doporuƒçujeme hr√°t na klidn√©m m√≠stƒõ nebo/a se sluch√°tky.</p>
      <!-- <p>Efekty je nejprve nutn√© zapnout.</p> -->
      <button class="js-dialog-sound-effects-open" type="button">Nastavit efekty</button>
      <section id="cta">
        <h2>Chci zaƒç√≠t hr√°t</h2>
        <p class="js-dialog-create-game-open">Zalo≈æte si svou vlastn√≠ hru.</p>
        <button class="js-dialog-create-game-open">Nov√° hra</button>
      </section>
      <section id="faq">
        <h2>Jak to funguje?</h2>
        <p>Nƒõkdo zalo≈æ√≠ novou hru.</p>
        <p>Pot√© nasd√≠li odkaz ostatn√≠m hr√°ƒç≈Øm.</p>
        <p>Spoluhr√°ƒçi se pomoc√≠ odkazu zapoj√≠ do hry.</p>
      </section>
      <section id="who">
        <h2>Kdo to udƒõlal?</h2>
        <p>
          <a href="https://topmonks.com/" title="Software development partner for your business">TopMonks</a> &amp; <a
            href="http://isymbio.cz/" title="SYMBIO Access devices">SYMBIO</a>.
          Jmenovitƒõ j√° (k√≥d), Tom√°≈° Fra≈àek (smysl), Veronika Hallerov√° (zvuk) a Jan Fabi√°n (hr√°ƒç).
        </p>
      </section>
      <section id="stats">
        <h2>Statistiky</h2>
        <p>
          K dne≈°n√≠mu dni si 0 hr√°ƒç≈Ø zahr√°lo 0 her,
          probƒõhlo celkem ~0 tah≈Ø.
        </p>
        <p>
          Nejv√≠ce v√Ωher m√° na sv√©m kontƒõ Bude Doplnƒõno,
          je to nejlep≈°√≠ hr√°ƒç na svƒõte!
        </p>
        <script type="module">
          const url = "https://firestore.googleapis.com/v1/projects/prsi-slysim/databases/(default)/documents/public/stats";
          const [firstLine, secondLine] = document.querySelectorAll("#stats p");

          fetch(url).then(r => r.json()).then(({ fields }) => {
            const { players, games, moves, winner } = fields;
            const score = winner.mapValue.fields;
            firstLine.textContent = `K dne≈°n√≠mu dni si ${players.integerValue} u≈æivatel≈Ø zahr√°lo ${games.integerValue} her, probƒõhlo celkem ~${moves.integerValue} tah≈Ø.`;
            secondLine.textContent = `Nejv√≠ce her (${score.count.integerValue}) m√° na sv√©m kontƒõ ${score.name.stringValue}, je to nejdel≈°√≠ hr√°ƒç na svƒõtƒõ!`;
          });
        </script>
      </section>
      <section id="copy">
        <p class="dimm" style="float: left">&copy; 02022.20</p>
        <p class="dimm" style="float: right">ü¶†,üå™, üåä, üåã, üá∫üá¶, ...</p>
      </section>
    </main>
  </div>
  <div class="js-dialog-create-game dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header class="dialog__header">
        <h1>Nov√° hra</h1>
        <p>
          Zde m≈Ø≈æete zalo≈æit vlastn√≠ hru.
        </p>
      </header>
      <form method="post" name="create-game">
        <label>
          <span>Poƒçet robot≈Ø</span>
          <input type="number" name="cpu-players" min="0" max="2" value="0" />
        </label>
        <label>
          <span>Poƒçet rozdan√Ωch karet</span>
          <input type="number" name="dealed-cards" min="1" max="6" value="4" />
        </label>
        <label>
          <span>Max. poƒçet hr√°ƒç≈Ø</span>
          <input type="number" name="max-players" min="2" max="8" value="4" />
        </label>
        <input type="hidden" name="id" />
        <button type="submit">Vytvo≈ôit hru</button>
        <h2>Co bude d√°l?</h2>
        <p>Po zalo≈æen√≠ budete automaticky p≈ôipojeni ke h≈ôe.</p>
        <p>
          P≈ôed zah√°jen√≠m hry je pot≈ôeba nasd√≠let odkaz ostatn√≠m spoluhr√°ƒç≈Øm.
          Tento odkaz, s smo≈ænost√≠ sd√≠lƒõn√≠, v√°m hra sama nab√≠dne.
        </p>
        <p>Hru m≈Ø≈æete zaƒç√≠t jakmile se u stolu sejde dostateƒçn√© mno≈æstv√≠ hr√°ƒç≈Ø.</p>
        <button type="button" class="js-dialog-create-game-close">Zav≈ô√≠t</button>
      </form>
    </section>
  </div>
  <div class="js-dialog-sound-effects dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="sound-effects-dialog-title">Zvukov√© efekty</h1>
        <p>Zde m≈Ø≈æete vypnout vybran√© nebo ve≈°ker√© zvuky hry.</p>
      </header>
      <p>
        <label class="flex">
          <input type="checkbox" name="music">
          <span>d√©≈°≈• na pozad√≠</span>
        </label>
      </p>
      <p>
        <label class="flex">
          <input type="checkbox" name="sounds" checked="checked">
          <span>zvuky karet</span>
        </label>
      </p>
      <button type="button" class="js-dialog-sound-effects-close">Zav≈ô√≠t</button>
    </section>
  </div>
  <div class="js-dialog-join-game dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="join-game-dialog-title">Zapojit se do hry</h1>
        <p>... dokud je u stolu m√≠sto.</p>
      </header>
      <form method="post" name="join-game">
        <label>
          <span>Jm√©no va≈°eho hr√°ƒçe</span>
          <input type="text" name="player-name" required />
        </label>
        <button type="submit">Zapojit se</button>
        <button type="button" class="js-dialog-join-game-close">Zav≈ô√≠t</button>
    </section>
  </div>
  <script type="module">
    window.addEventListener("resize", function syncHeight() {
      document.documentElement.style.setProperty(
        "--window-inner-height",
        `${window.innerHeight}px`
      );
    });
  </script>
  <script type="module">
    import Dialog, { setDefaults as setDialogDefaults } from "/library/a11y-dialog-component/esm.js";
    import { auth } from "/application.js";
    import { sendSignInLinkToEmail, getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { authCompleteEmailStoredLocally } from "/storage.js";
    import { isVerifyLink, useVerifyLink, watchUser } from "/user.js";
    import { formDataToPayload, deepMerge } from "/library.js";
    import { httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-functions.js";
    import { playerNameStoredLocally } from "/storage.js";
    import { fns } from "/application.js";
    import { render } from "https://unpkg.com/lit-html@2.2.0/lit-html.js?module";
    import * as templates from "/templates.js";
    import Sounds, { toPositionInCircle } from "/sounds.js";
    import { db } from "/application.js";
    import { doc, onSnapshot, addDoc, collection, getDoc, } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getPlayer, CHANGE_CARD_VALUE } from "/library/prsi/index.js";
    import {
      SHUFFLE as SHUFFLE_MOVE,
      DRAW as DRAW_MOVE,
      PLAY as PLAY_MOVE,
      DEAL as DEAL_MOVE,
      STAY as STAY_MOVE,
    } from "/library/prsi/moves.js";

    const createGame = new Dialog(".js-dialog-create-game", {
      openingSelector: ".js-dialog-create-game-open",
      closingSelector: ".js-dialog-create-game-close",
      labelledby: "create-game-dialog-title",
    });

    createGame.dialog.querySelector("form").addEventListener(
      "submit",
      handleCreateGameSubmit
    );

    const soundEffects = new Dialog(".js-dialog-sound-effects", {
      openingSelector: ".js-dialog-sound-effects-open",
      closingSelector: ".js-dialog-sound-effects-close",
      labelledby: "sound-effects-dialog-title",
    });
    Sounds.setSoundsPath("/assets/")

    const MOVE_EFFECTS = {
      default: "deck.wav",
      [SHUFFLE_MOVE]: "shuffle1.wav", // "shuffle2.wav",
      [PLAY_MOVE]: "play-card.wav",
      [DEAL_MOVE]: "deal-cards.wav",
      [DRAW_MOVE]: "draw.wav",
      // [STAY_MOVE]: "stay.wav",
    };


    for (let input of soundEffects.dialog.querySelectorAll(`input[type="checkbox"]`)) {
      input.addEventListener(
        "change",
        handleSoundEffectsChange
      );
    }

    const joinGame = new Dialog(".js-dialog-join-game", {
      openingSelector: ".js-dialog-join-game-open",
      closingSelector: ".js-dialog-join-game-close",
      labelledby: "join-game-dialog-title",
    });

    const playerNameInput = joinGame.dialog.querySelector(`form input[name="player-name"]`);
    playerNameInput.value = playerNameStoredLocally.read();
    playerNameInput.addEventListener("change", ({ target: { value } }) => {
      playerNameStoredLocally.write(value);
    });


    GAME: {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has("game")) {
        handleGamePlay(urlParams.get("game")); // Existing game ENTRY POINT
      }
    }

    async function handleCreateGameSubmit(event) {
      event.preventDefault();

      const auth = getAuth();
      try {
        if (!auth.currentUser) {
          console.log("Signing in anonymously..");
          await signInAnonymously(auth);
        } else {
          console.log("Already signed in as", auth.currentUser);
        }
      } catch (error) {
        alert(`Nepoda≈ôilo se p≈ôihl√°sit anonymnƒõ: ${error.message}`);
        console.error(error);
      }

      const submitButton = createGame.dialog.querySelector("button[type=submit]");
      const submitButtonLabel = submitButton.textContent;
      submitButton.setAttribute("disabled", "disabled");
      submitButton.textContent = "Vytv√°≈ô√≠m hru";

      try {
        const formData = new FormData(event.target);
        const payload = formDataToPayload(formData);
        const { data: { id: gameId } = {} } = await httpsCallable(fns, "createGame")(payload);

        if (!gameId) {
          alert("Hru se nepoda≈ôilo vytvo≈ôit. Zkuste to pros√≠m znovu.");
        } else {
          history.pushState({}, "New Game", `/?game=${gameId}`);
          handleGamePlay(gameId); // üëå New Game ENTRYPOINT
          createGame.close();
        }
      } catch ({ message, code }) {
        if (code === "functions/permission-denied") {
          if (confirm("Zvl√°≈°tn√≠, ale na toto nem√°te pr√°vo. Zkuste naƒç√≠st str√°nku znovu.")) {
            window.location.reload();
          }
        } else {
           alert(`Nastala chyba p≈ôi vytv√°≈ôen√≠ hry.\n${message}`);
        }
      } finally {
        submitButton.removeAttribute("disabled");
        submitButton.textContent = submitButtonLabel;
      }
    }

   function handleSoundEffectsChange(event) {
     event.preventDefault();
     const { name, checked: enabled, type } = event.target;
     if (type !== "checkbox") throw new Error("Unexpected target type");
     switch (name) {
       case "music":
         Sounds.enable("rain.mp3", enabled, { autoplay: true, loop: true, gain: .4 });
         break;
       case "sounds":
         Sounds.enableAll(Object.values(MOVE_EFFECTS), enabled);
         if (enabled) Sounds.play(MOVE_EFFECTS.default);
         break;
       default:
         throw new Error("Unexpected sound effect name");
     }
   }

   function handleGamePlay(gameId) {
     console.info("Game play", gameId);
     if (window.gtag) {
       gtag('event', 'conversion', { 'send_to': 'AW-970323658/8y9YCJz96IsYEMrt184D' });
     }

     const [
       headerElement,
       contentElement
     ] = [".js-header", ".js-content"].map(s => document.querySelector(s));

     clearStaticPage: {
       headerElement.firstElementChild.remove();
       contentElement.firstElementChild.remove();
       window.scrollTo(0, 0);
     }

     let state = {
       game: undefined,
       user: null,
       selectedCard: undefined,
       selectedColor: undefined,
     };


     joinGame.dialog.querySelector("form").addEventListener(
       "submit",
       async (event) => {
         const game = await handleJoinGameSubmit(event);
         if (game) {
           emit({ game });
           Sounds.enableAll(Object.values(MOVE_EFFECTS), true);
           Sounds.play(MOVE_EFFECTS.default);
         }
       }
     );

     watchUser((u) => {
       emit({ user: u?.toJSON() });
     });

     const handlers = {
       handleLeaveGame() {
         window.location.href = "/";
       },
       handleShareGame(event) {
         event.preventDefault();
         const shateLink = window.location.href;
         const shareText = `Hra je zalo≈æen√°, staƒç√≠ se p≈ôipojit..`;

         if (navigator.share) {
           navigator.share({
             text: shareText,
             url: shateLink
           });
         } else {
           navigator.clipboard
             .writeText(`${shateLink} ${shareText}`)
             .then(() => alert("Odkaz na hru byl zkop√≠rov√°n do schr√°nky."))
         }
       },
       async handleMove(event) {
         const urlParams = new URLSearchParams(window.location.search);
         const gameId = urlParams.get("game");

         const buttonElement = event.target;
         const { name: moveType } = buttonElement;

         try {
           emit({ busy: moveType });

           await Sounds.playTimes(
             MOVE_EFFECTS[moveType] || MOVE_EFFECTS.default,
             buttonElement.dataset.n || 1
           ).catch(O_o => console.error(O_o));

           const { data: { game } } = await httpsCallable(fns, "gameMove")({
             moveType,
             gameId,
             card: state.selectedCard,
             color: state.selectedColor,
           });

           emit({
             game,
             // cleanup ui controls
             selectedCard: null,
             selectedColor: null,
           });

         } catch (error) {
           console.error(error);
           // ‚ÄºÔ∏è even server error will tell it is wrong move.
           alert("≈†patn√Ω tah.");
         } finally {
           emit({ busy: null });
         }
       },
       handlePlayerCardSelect(event) {
         const cardId = event.target.value;
         const player = getPlayer(state.game, state.user.uid);
         const { value, color, id } = player.cards.find(card => card.id === cardId);
         const makeMoveButtonElement = document.querySelector(`button[name="${PLAY_MOVE}"]`);

         if (value === CHANGE_CARD_VALUE) {
           emit({
             selectedCard: { value, color, id },
             selectedColor: color
           });
         } else {
           emit({ selectedCard: { value, color, id } });
         }
         makeMoveButtonElement.focus();
       },
       handleCardColorSelect(event) {
         const makeMoveButtonElement = document.querySelector(`button[name="${PLAY_MOVE}"]`);
         const color = event.target.value;
         emit({ selectedColor: color });
         makeMoveButtonElement.focus();
       },
       // ...
     };

     function emit(payload = {}) {
       state = deepMerge(state, payload);

       render(
         templates.header(state, handlers),
         headerElement
       );
       render(
         templates.content(state, handlers),
         contentElement,
       );
       window.debug = state;
     }


     const queryToPublicCopy = () => `play/public/game/${gameId}`;
     const queryToPlayerCopy = () => `play/${state.user?.uid}/game/${gameId}`;

     // Firstly using public copy, then, once user joins the game we start using private copy
     let usedCopyQuery = queryToPublicCopy();
     const unsubcribePublicCopy = onSnapshot(doc(db, usedCopyQuery), handleSnapshot);

     function handleSnapshot(d) {
       const game = d.data();

       // Uplne inak todleto, predbiha se to, neni to spolehlivy a tak.
       // if (
       //   game.lastMove &&
       //   game.lastMove.type !== state.game?.lastMove?.type &&
       //   game.lastMove?.player.id !== state.user?.uid
       // ) {
       if (
         state.game &&
         game.lastMove && // je to update stavu hry
         game.lastMove.player.id !== state.user?.uid && // nejsem to j√°
         (
           // a neni to stejn√Ω tah jako p≈ôedchoz√≠
           game.lastMove.player.id !== state.game.lastMove?.player.id ||
           game.lastMove.type !== state.game.lastMove.type
         )
       ) {
         setTimeout(() => {
           alerto(templates.moveMessage(game, state.user));
           playPlayerMoveEffects(game.lastMove, game.players, game.settings);
         }, 0);
       }

       if (
         state.user?.uid &&
         usedCopyQuery === queryToPublicCopy() &&
         getPlayer(game, state.user?.uid)
       ) {
         usedCopyQuery = queryToPlayerCopy();
         console.info("Switching to private copy", usedCopyQuery);
         unsubcribePublicCopy();
         onSnapshot(doc(db, usedCopyQuery), handleSnapshot);
       } else {
         try {
           emit({ game });
         } catch (e) {
           debugger;
         }
       }
     }


     function playPlayerMoveEffects(lastMove, players = [], settings = {}) {
       const sound = MOVE_EFFECTS[lastMove.type] || MOVE_EFFECTS.default;
       const position = toPositionInCircle({
         index: players.findIndex(player => player.id === lastMove.player.id),
         length: players.length,
       });

       if (lastMove.type === SHUFFLE_MOVE) {
         Sounds.playTimes(sound, settings.dealCards, {
           position,
         });
       } else if (lastMove.type === DRAW_MOVE) {
         Sounds.playTimes(sound, lastMove.drawn, {
           position,
         });
       } else {
         Sounds.play(sound, { position });
       }
     }

   }

   async function handleJoinGameSubmit(event) {
     console.warn("TODO: allow only one same player name in the game, remove playerId from public game events then")
     event.preventDefault();
     const urlParams = new URLSearchParams(window.location.search);
     const gameId = urlParams.get("game");

     for (let trigger of joinGame.openingTriggers) {
       trigger.setAttribute("disabled", "disabled");
     }

     const submitButton = joinGame.dialog.querySelector("button[type=submit]");
     const submitButtonLabel = submitButton.textContent;
     submitButton.setAttribute("disabled", "disabled");
     submitButton.textContent = "P≈ôised√°m";

     if (!gameId) {
       console.error("Game ID not found");
       if (confirm("Ztratilo se ID hry. Budete p≈ôesmƒõrov√°ni na hlavn√≠ str√°nku.")) {
         window.location.href = "/";
       }
       return;
     }

     const formData = new FormData(event.target);
     const playerName = formData.get("player-name");

     try {
       const { data: { game } = {} } = await httpsCallable(fns, "joinGame")({ playerName, gameId });
       submitButton.removeAttribute("disabled");
       submitButton.textContent = submitButtonLabel;
       joinGame.close();
       return game;
     } catch (error) {
       if (error.code === "already-exists") {
         alert(`${playerName} ji≈æ hraje v t√©to h≈ôe.`);
       } else {
         alert(`Nastala chyba p≈ôi p≈ôipojov√°n√≠ k h≈ôe: ${error.message}`);
       }
     }
   }

  </script>
</body>

</html>

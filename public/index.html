<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pr코칤, sly코칤m!</title>
  <meta property="og:title" content="Zahraje코 si se mnou pr코칤?">
  <meta property="og:site_name" content="Pr코칤, sly코칤m!">
  <meta property="og:url" content="https://prsi-slysim.web.app/">
  <meta property="og:description"
    content="Online hra pr코칤 pro v칤ce hr치캜콢, vytvo콏en치 prim치rn캩 pro u쬴vatele se zrakov칳m handicapem.">
  <meta property="og:type" content="website">
  <!-- <meta property="og:image" content=""> -->
  <style>
    [aria-hidden="true"] {
      display: none;
    }
  </style>
  <link rel="stylesheet" href="/styles.css">
</head>

<body>
  <div class="js-header">
    <header>
      <h1>Pr코칤 sly코im!</h1>
      <p>Online hra pr코칤 pro v칤ce hr치캜콢, vytvo콏en치 prim치rn캩 pro u쬴vatele se zrakov칳m handicapem.</p>
    </header>
  </div>
  <div class="js-content">
    <main>
      <h2>Klasick칠 pr코칤</h2>
      <p>
        <em>Pr코칤 sly코im</em> v치m zprost콏edkuje z치쬴tek z hran칤 b캩쬹칠 karetn칤 hry
        <a href="https://cs.wikipedia.org/wiki/Pr%C5%A1%C3%AD" title="Wikipedie">pr코칤</a>
        za pou쬴t칤 oby캜ejn칠ho textu a akustick칳ch efekt콢.
      </p>
      <h2>Zvukov칠 efekty</h2>
      <p>Doporu캜ujeme hr치t na klidn칠m m칤st캩 nebo/a se sluch치tky.</p>
      <!-- <p>Efekty je nejprve nutn칠 zapnout.</p> -->
      <button class="js-dialog-sound-effects-open" type="button">Nastavit efekty</button>
      <section id="cta">
        <h2>Chci za캜칤t hr치t</h2>
        <p class="js-dialog-verify-self-open">Pouze ov캩콏en칤 u쬴vatel칠 se mouhou zapojit do hry.</p>
        <p class="js-dialog-create-game-open" aria-hidden="true">Zalo쬾e si svou vlastn칤 hru.</p>
        <button class="js-dialog-verify-self-open">Ov캩콏it se</button>
        <button aria-hidden="true" class="js-dialog-create-game-open">Nov치 hra</button>
      </section>
      <section id="faq">
        <h2>Jak to funguje?</h2>
        <p>N캩kdo zalo쮂 novou hru.</p>
        <p>Pot칠 nasd칤li odkaz ostatn칤m hr치캜콢m (nap콏. v sms).</p>
        <p>Spoluhr치캜i se pomoc칤 odkazu zapoj칤 do hry.</p>
        <p>Podm칤nka: Hry se mohou 칰캜astnit pouze ov캩콏en칤 u쬴vatel칠.</p>
      </section>
    </main>
  </div>
  <div class="js-dialog-verify-self dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="verify-self-dialog-title">Ov캩콏it se p콏es email</h1>
        <p>Do hry se mohou zapojit pouze ov캩콏en칤 u쬴vatel칠. Sta캜칤 k tomu v코ak oby캜ejn칳 email.</p>
      </header>
      <form method="post" name="verify-self">
        <label for="email">V치코 email:</label>
        <input type="email" id="email" name="email" placeholder="pepa@zdepa.cz" required>
        <p>Na uvedenou adresu v치m bude zasl치n odkaz pro p콏ihl치코en칤.</p>
        <button type="submit">Odeslat</button>
        <button type="button" class="js-dialog-verify-self-close">Zav콏칤t</button>
      </form>
    </section>
  </div>
  <div class="js-dialog-create-game dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header class="dialog__header">
        <h1>Nov치 hra</h1>
        <p>
          Zde m콢쬰te zalo쬴t vlastn칤 hru.
        </p>
      </header>
      <form method="post" name="create-game">
        <label>
          <span>Max. po캜et hr치캜콢</span>
          <input type="number" name="max-players" min="2" max="8" value="4" />
        </label>
        <label>
          <span>Po캜et rozdan칳ch karet</span>
          <input type="number" name="dealed-cards" min="1" max="6" value="4" />
        </label>
        <input type="hidden" name="id" />
        <button type="submit">Vytvo콏it hru</button>
        <h2>Co bude d치l?</h2>
        <p>Po zalo쬰n칤 budete automaticky p콏ipojeni ke h콏e.</p>
        <p>
          P콏ed zah치jen칤m hry je pot콏eba nasd칤let odkaz ostatn칤m spoluhr치캜콢m.
          Tento odkaz, s smo쬹ost칤 sd칤l캩n칤, v치m hra sama nab칤dne.
        </p>
        <p>Hru m콢쬰te za캜칤t jakmile se u stolu sejde dostate캜n칠 mno쬽tv칤 hr치캜콢.</p>
        <button type="button" class="js-dialog-create-game-close">Zav콏칤t</button>
      </form>
    </section>
  </div>
  <div class="js-dialog-sound-effects dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="sound-effects-dialog-title">Zvukov칠 efekty</h1>
        <p>Zde m콢쬰te vypnout vybran칠 nebo ve코ker칠 zvuky hry.</p>
      </header>
      <p>
        <label class="flex">
          <input type="checkbox" name="music">
          <span>d칠코콘 na pozad칤</span>
        </label>
      </p>
      <p>
        <label class="flex">
          <input type="checkbox" name="sounds" checked="checked">
          <span>zvuky karet</span>
        </label>
      </p>
      <button type="button" class="js-dialog-sound-effects-close">Zav콏칤t</button>
    </section>
  </div>
  <div class="js-dialog-join-game dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="join-game-dialog-title">Zapojit se do hry</h1>
        <p>... dokud je u stolu m칤sto.</p>
      </header>
      <form method="post" name="join-game">
        <label>
          <span>Jm칠no va코eho hr치캜e</span>
          <input type="text" name="player-name" required />
        </label>
        <button type="submit">Zapojit se</button>
        <button type="button" class="js-dialog-join-game-close">Zav콏칤t</button>
    </section>
  </div>
  <script type="module">
    window.addEventListener("resize", function syncHeight() {
      document.documentElement.style.setProperty(
        "--window-inner-height",
        `${window.innerHeight}px`
      );
    });
  </script>
  <script type="module">
    import Dialog, { setDefaults as setDialogDefaults } from "/library/a11y-dialog-component/esm.js";
    import { auth } from "/application.js";
    import { sendSignInLinkToEmail } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { authCompleteEmailStoredLocally } from "/storage.js";
    import { isVerifyLink, useVerifyLink, currentUser } from "/user.js";
    import { formDataToPayload, deepMerge } from "/library.js";
    import { httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-functions.js";
    import { playerNameStoredLocally } from "/storage.js";
    import { fns } from "/application.js";
    import { render } from "https://unpkg.com/lit-html@2.1.1/lit-html.js?module";
    import * as templates from "/templates.js";
    import Sounds from "/sounds.js";
    import { db } from "/application.js";
    import { doc, onSnapshot, addDoc, collection, getDoc, } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { onCurrentUserChanged } from "/user.js";

    const verifySelf = new Dialog(".js-dialog-verify-self", {
      openingSelector: ".js-dialog-verify-self-open",
      closingSelector: ".js-dialog-verify-self-close",
      labelledby: "verify-self-dialog-title",
    });

    verifySelf.dialog.querySelector("form").addEventListener(
      "submit",
      handleVerifySelfSubmit
    );

    const createGame = new Dialog(".js-dialog-create-game", {
      openingSelector: ".js-dialog-create-game-open",
      closingSelector: ".js-dialog-create-game-close",
      labelledby: "create-game-dialog-title",
    });

    createGame.dialog.querySelector("form").addEventListener(
      "submit",
      handleCreateGameSubmit
    );

    const soundEffects = new Dialog(".js-dialog-sound-effects", {
      openingSelector: ".js-dialog-sound-effects-open",
      closingSelector: ".js-dialog-sound-effects-close",
      labelledby: "sound-effects-dialog-title",
    });
    Sounds.setSoundsPath("/assets/")


    for (let input of soundEffects.dialog.querySelectorAll(`input[type="checkbox"]`)) {
      input.addEventListener(
        "change",
        handleSoundEffectsChange
      );
    }

    currentUser().then(handleUserVerifyChange).then((user) => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has("game")) {
        handleGamePlay({ gameId: urlParams.get("game"), user }); // 游녧 Running Game ENTRYPOINT
      }
    }).catch(error => {
      console.error(error);
      if (confirm(`Chyba nastala: ${error.message}. Zkusit na캜칤st str치nku znovu?`)) {
        window.location.reload();
      }
    });


    const joinGame = new Dialog(".js-dialog-join-game", {
      openingSelector: ".js-dialog-join-game-open",
      closingSelector: ".js-dialog-join-game-close",
      labelledby: "join-game-dialog-title",
    });

    const playerNameInput = joinGame.dialog.querySelector('form input[name="player-name"]');
    playerNameInput.value = playerNameStoredLocally.read();
    playerNameInput.addEventListener("change", ({ target: { value } }) => {
      playerNameStoredLocally.write(value);
    });

    joinGame.dialog.querySelector("form").addEventListener(
      "submit",
      handleJoinGameSubmit
    );


    function handleUserVerifyChange(user) {
      const isUserVerified = (user || undefined)?.emailVerified;

      const { href: link } = window.location;

      if (!isUserVerified && isVerifyLink(link)) {
        let email = authCompleteEmailStoredLocally.read();
        if (!email) {
          alert(
            "Vypad치 to, 쬰 dokon캜ujete ov캩콏en칤 u쬴vatele v jin칠m prohl칤쬰캜i ne ve kter칠m jste za캜ali. "
          );
          email = window.prompt(
            `Pokud chcete pokra캜ovat v tomto prohl쬰캜i, vypln캩 svou email adresu znovu:`
          );
        }

        useVerifyLink(link, email).then(({ user: u }) => {
          const urlParams = new URLSearchParams(window.location.search);
          history.pushState({}, "Verified", urlParams.has("game") ? `/?game=${urlParams.get("game")}` : "/");
          handleUserVerifyChange(u);
        });
      }

      for (let trigger of verifySelf.openingTriggers) {
        if (isUserVerified) trigger.setAttribute("aria-hidden", "true");
        else trigger.removeAttribute("aria-hidden");
      }

      for (let trigger of createGame.openingTriggers) {
        if (isUserVerified) trigger.removeAttribute("aria-hidden");
        else trigger.setAttribute("aria-hidden", "true");
      }

      return user;
    };

    async function handleVerifySelfSubmit(event) {
      event.preventDefault();
      const { origin, search } = window.location;

      try {
        const formData = new FormData(event.target);
        const urlParams = new URLSearchParams(window.location.search);
        const email = formData.get("email");
        const settings = {
          url: `${origin}${urlParams.has("game") ? `?game=${urlParams.get("game")}` : ""}`,
          handleCodeInApp: true,
        };

        await sendSignInLinkToEmail(auth, email, settings);
        authCompleteEmailStoredLocally.write(email);

        alert(`Odesl치no, pokra캜ujte pros칤m do va코칤 ${email} schr치nky.\n\Tuto str치nku m콢쬰te zav콏칤t.`);
      } catch (fok) {
        console.error(fok)
        alert(`Chyba p콏i odes칤l치n칤 odkazu: ${fok.message}. Zkuste to pros칤m znovu.`);
      }
    }

    async function handleCreateGameSubmit(event) {
      event.preventDefault();

      const submitButton = createGame.dialog.querySelector("button[type=submit]");
      const submitButtonLabel = submitButton.textContent;
      submitButton.setAttribute("disabled", "disabled");
      submitButton.textContent = 'Vytv치콏칤m hru...';

      try {
        const formData = new FormData(event.target);
        const payload = formDataToPayload(formData);
        const { data: { id: gameId } = {} } = await httpsCallable(fns, "createGame")(payload);

        if (!gameId) {
          alert("Hru se nepoda콏ilo vytvo콏it. Zkuste to pros칤m znovu.");
        } else {
          history.pushState({}, "New Game", `/?game=${gameId}`);
          createGame.close();
          const user = await currentUser();
          handleGamePlay({ gameId, user }); // 游녧 New Game ENTRYPOINT
        }
      } catch ({ message, code }) {
        if (code === "functions/permission-denied") {
          if (confirm("Zvl치코tn칤, ale na toto nem치te pr치vo. Zkuste na캜칤st str치nku znovu.")) {
            window.location.reload();
          }
        } else {
          alert(`Nastala chyba p콏i vytv치콏en칤 hry.\n${message}`);
        }
      } finally {
        submitButton.removeAttribute("disabled");
        submitButton.textContent = submitButtonLabel;
      }
    }

    function handleSoundEffectsChange(event) {
      event.preventDefault();
      const { name, checked: enabled, type } = event.target;
      if (type !== "checkbox") throw new Error("Unexpected target type");
      switch (name) {
        case "music":
          Sounds.enable("rain.mp3", enabled, { autoplay: true, loop: true, gain: .4 });
          break;
        case "sounds":
          Sounds.enableAll([
            "shuffle1.wav",
            "shuffle2.wav",
            "play-card.wav",
            "deal-cards.wav",
            "deck.wav",
            "draw.wav"
          ], enabled);
          if (enabled) Sounds.play("deck.wav");
          break;
        default:
          throw new Error("Unexpected name");
      }
    }

    function handleGamePlay({ gameId, user }) {
      const [
        headerElement,
        contentElement
      ] = [".js-header", ".js-content"].map(s => document.querySelector(s));

      clearStaticPage: {
        headerElement.firstElementChild.remove();
        contentElement.firstElementChild.remove();
        window.scrollTo(0, 0);
      }

      let state = {
        title: "Nov치 hra",
        game: undefined,
        user: user?.toJSON(),
        selectedCard: undefined,
        selectedColor: undefined,
      };

      const handlers = {
        handleLeaveGame() {
          window.location.href = "/";
        },
        handleShareGame(event) {
          event.preventDefault();
          const shateLink = window.location.href;
          const shareText = `Zahrajem si pr코칤? Hra je zalo쬰n치, sta캜칤 se p콏ipojit..`;

          if (navigator.share) {
            navigator.share({
              text: shareText,
              url: shateLink
            });
          } else {
            navigator.clipboard
              .writeText(`${shareText} ${shateLink}`)
              .then(() => alert("Odkaz na hru byl zkop칤rov치n do schr치nky."))
          }
        },
        handleYourMove(event) {
          const urlParams = new URLSearchParams(window.location.search);
          const gameId = urlParams.get("game");

          const buttonElement = event.target;
          const { name: moveType } = buttonElement;
          const buttonElementLabel = buttonElement.textContent;
          buttonElement.setAttribute("disabled", "disabled");

          buttonElement.textContent = buttonElement.dataset.busyTitle || "Zpracov치v치m...";
          Promise.all([
            Sounds.play(buttonElement.dataset.soundEffect || "plop.m4a"),
            httpsCallable(fns, "gameMove")({
              moveType,
              gameId,
              card: state.selectedCard,
              color: state.selectedColor
            }),
          ]).catch(error => {
            console.error(error);
            alert(`Nastala chyba "${error.message}". Zkuste to pros칤m znovu.`);
          }).finally(() => {
            buttonElement.removeAttribute("disabled");
            buttonElement.textContent = buttonElementLabel;
          });

        },
        handlePlayerCardSelect(event) {
          emit({ selectedCard: event.target.value });
        },
        // ...
      };



      function emit(payload = {}) {
        state = deepMerge(state, payload);

        render(
          templates.header(state, handlers),
          headerElement
        );
        render(
          templates.content(state, handlers),
          contentElement,
        );
        console.info("STATE UPDATE", state);
      }


      onCurrentUserChanged((user) => {
        emit({ user: user?.toJSON() });
      });

      const queryToPublicCopy = `play/public/game/${gameId}`;
      const queryToPlayerCopy = `play/${user?.uid}/game/${gameId}`;

      getDoc(doc(db, queryToPublicCopy)).then((doc) => {
        emit({ game: doc.data() });
      });

      // Firstly using public copy, then, once user joins the game we start using private copy
      let usedCopy = queryToPublicCopy;

      const unsubcribePublicCopy = onSnapshot(doc(db, queryToPublicCopy), handleSnapshot);

      function handleSnapshot(d) {
        const game = d.data();

        emit({ game });

        if (
          usedCopy === queryToPublicCopy &&
          game.players.map(({ id = null }) => id).includes(user?.uid)
        ) {
          usedCopy = queryToPlayerCopy;
          unsubcribePublicCopy();
          onSnapshot(doc(db, usedCopy), handleSnapshot);
        }
      }

    }

    async function handleJoinGameSubmit(event) {
      console.warn("TODO: allow only one same player name in the game, remove playerId from public game events then")
      event.preventDefault();
      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get("game");

      const submitButton = joinGame.dialog.querySelector("button[type=submit]");
      const submitButtonLabel = submitButton.textContent;
      submitButton.setAttribute("disabled", "disabled");
      submitButton.textContent = 'P콏ised치m...';

      if (!gameId) {
        if (confirm("Ztratilo se ID hry. Budete p콏esm캩rov치ni na hlavn칤 str치nku.")) {
          console.error("Game ID not found");
          window.location.href = "/";
        }
        return;
      }

      const formData = new FormData(event.target);
      const playerName = formData.get("player-name");
      const { data: { error } = {} } = await httpsCallable(fns, "joinGame")({ playerName, gameId });

      if (error) {
        if (error.code === "already-exists") {
          alert(`${playerName} ji hraje v t칠to h콏e.`);
        } else {
          alert(`Nastala chyba p콏i p콏ipojov치n칤 k h콏e: ${error.message}`);
        }
      } else {
        submitButton.removeAttribute("disabled");
        submitButton.textContent = submitButtonLabel;
        joinGame.close();
      }
    }

  </script>
</body>

</html>
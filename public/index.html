<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrÅ¡Ã­, slyÅ¡Ã­m!</title>
  <style>
    [aria-hidden="true"] {
      display: none;
    }
  </style>
  <link rel="stylesheet" href="/styles.css">
</head>

<body>
  <div class="js-header">
    <header>
      <h1>PrÅ¡Ã­ slyÅ¡im!</h1>
      <p>Online hra prÅ¡Ã­ pro vÃ­ce hrÃ¡ÄÅ¯, vytvoÅ™enÃ¡ primÃ¡rnÄ› pro uÅ¾ivatele se zrakovÃ½m handicapem.</p>
    </header>
  </div>
  <div class="js-content">
    <main>
      <h2>KlasickÃ© prÅ¡Ã­</h2>
      <p>
        <em>PrÅ¡Ã­ slyÅ¡im</em> vÃ¡m zprostÅ™edkuje zÃ¡Å¾itek z hranÃ­ bÄ›Å¾nÃ© karetnÃ­ hry
        <a href="https://cs.wikipedia.org/wiki/Pr%C5%A1%C3%AD" title="Wikipedie">prÅ¡Ã­</a>
        za pouÅ¾itÃ­ obyÄejnÃ©ho textu a akustickÃ½ch efektÅ¯.
      </p>
      <h2>ZvukovÃ© efekty</h2>
      <p>DoporuÄujeme hrÃ¡t na klidnÃ©m mÃ­stÄ› nebo/a se sluchÃ¡tky.</p>
      <!-- <p>Efekty je nejprve nutnÃ© zapnout.</p> -->
      <button class="js-dialog-sound-effects-open">Nastavit efekty</button>
      <section id="cta">
        <h2>Chci zaÄÃ­t hrÃ¡t</h2>
        <p class="js-dialog-verify-self-open">Pouze ovÄ›Å™enÃ­ uÅ¾ivatelÃ© se mouhou zapojit do hry.</p>
        <p class="js-dialog-create-game-open" aria-hidden="true">ZaloÅ¾te si svou vlastnÃ­ hru.</p>
        <button class="js-dialog-verify-self-open">OvÄ›Å™it se</button>
        <button aria-hidden="true" class="js-dialog-create-game-open">NovÃ¡ hra</button>
      </section>
      <section id="faq">
        <h2>Jak to funguje?</h2>
        <p>NÄ›kdo zaloÅ¾Ã­ novou hru.</p>
        <p>PotÃ© nasdÃ­li odkaz ostatnÃ­m hrÃ¡ÄÅ¯m (napÅ™. v sms).</p>
        <p>SpoluhrÃ¡Äi se pomocÃ­ odkazu zapojÃ­ do hry.</p>
        <p>PodmÃ­nka: Hry se mohou ÃºÄastnit pouze ovÄ›Å™enÃ­ uÅ¾ivatelÃ©.</p>
      </section>
    </main>
  </div>
  <div class="js-dialog-verify-self dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="verify-self-dialog-title">OvÄ›Å™it se pÅ™es email</h1>
        <p>Do hry se mohou zapojit pouze ovÄ›Å™enÃ­ uÅ¾ivatelÃ©. StaÄÃ­ k tomu vÅ¡ak obyÄejnÃ½ email.</p>
      </header>
      <form method="post" name="verify-self">
        <label for="email">VÃ¡Å¡ email:</label>
        <input type="email" id="email" name="email" placeholder="Zde zandejte svÅ¯j e-mail, prosÃ­m" required>
        <p>Na uvedenou adresu vÃ¡m bude zaslÃ¡n odkaz pro pÅ™ihlÃ¡Å¡enÃ­.</p>
        <button type="submit">Odeslat</button>
        <button type="button" class="js-dialog-verify-self-close">ZavÅ™Ã­t</button>
      </form>
    </section>
  </div>
  <div class="js-dialog-create-game dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header class="dialog__header">
        <h1>NovÃ¡ hra</h1>
        <p>
          Zde mÅ¯Å¾ete zaloÅ¾it vlastnÃ­ hru.
        </p>
      </header>
      <form method="post" name="create-game">
        <label>
          <span>JmÃ©no vaÅ¡eho hrÃ¡Äe</span>
          <input type="text" name="player-name" required />
        </label>
        <label>
          <span>Max. poÄet hrÃ¡ÄÅ¯</span>
          <input type="number" name="max-players" min="2" max="8" value="4" />
        </label>
        <label>
          <span>PoÄet rozdanÃ½ch karet</span>
          <input type="number" name="dealed-cards" min="1" max="6" value="4" />
        </label>
        <input type="hidden" name="id" />
        <button type="submit">VytvoÅ™it hru</button>
        <h2>Co bude dÃ¡l?</h2>
        <p>Po zaloÅ¾enÃ­ budete automaticky pÅ™ipojeni ke hÅ™e.</p>
        <p>
          PÅ™ed zahÃ¡jenÃ­m hry je potÅ™eba nasdÃ­let odkaz ostatnÃ­m spoluhrÃ¡ÄÅ¯m.
          Tento odkaz, s smoÅ¾nostÃ­ sdÃ­lÄ›nÃ­, vÃ¡m hra sama nabÃ­dne.
        </p>
        <p>Hru mÅ¯Å¾ete zaÄÃ­t jakmile se u stolu sejde dostateÄnÃ© mnoÅ¾stvÃ­ hrÃ¡ÄÅ¯.</p>
        <button type="button" class="js-dialog-create-game-close">ZavÅ™Ã­t</button>
      </form>
    </section>
  </div>
  <div class="js-dialog-sound-effects dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="sound-effects-dialog-title">ZvukovÃ© efekty</h1>
        <p>Zde mÅ¯Å¾ete vypnout vybranÃ© nebo veÅ¡kerÃ© zvuky hry.</p>
      </header>
      <div class="flex" style="margin-bottom: 32px">
        <label class="flex">
          <input type="checkbox" name="music">
          <span>dÃ©Å¡Å¥ na pozadÃ­</span>
        </label>
        <label class="flex">
          <input type="checkbox" name="sounds">
          <span>zvuky karet</span>
        </label>
      </div>
      <button type="button" class="js-dialog-sound-effects-close">ZavÅ™Ã­t</button>
    </section>
  </div>
  <script type="module">
    window.addEventListener("resize", function syncHeight() {
      document.documentElement.style.setProperty(
        "--window-inner-height",
        `${window.innerHeight}px`
      );
    });
  </script>
  <script type="module">
    import Dialog, { setDefaults as setDialogDefaults } from "/library/a11y-dialog-component/esm.js";
    import { auth } from "/application.js";
    import { sendSignInLinkToEmail } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { authCompleteEmailStoredLocally } from "/storage.js";
    import { isVerifyLink, useVerifyLink, currentUser } from "/user.js";
    import { formDataToPayload } from "/library.js";
    import { httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-functions.js";
    import { playerNameStoredLocally } from "/storage.js";
    import { fns } from "/application.js";
    import { render } from "https://unpkg.com/lit-html@2.1.1/lit-html.js?module";
    import * as templates from "/templates.js";
    import Sounds from "/sounds.js";

    const verifySelf = new Dialog(".js-dialog-verify-self", {
      openingSelector: ".js-dialog-verify-self-open",
      closingSelector: ".js-dialog-verify-self-close",
      labelledby: "verify-self-dialog-title",
    });

    verifySelf.dialog.querySelector("form").addEventListener(
      "submit",
      handleVerifySelfSubmit
    );

    const createGame = new Dialog(".js-dialog-create-game", {
      openingSelector: ".js-dialog-create-game-open",
      closingSelector: ".js-dialog-create-game-close",
      labelledby: "create-game-dialog-title",
    });

    createGame.dialog.querySelector("form").addEventListener(
      "submit",
      handleCreateGameSubmit
    );

    const playerNameInput = createGame.dialog.querySelector('form input[name="player-name"]');
    playerNameInput.value = playerNameStoredLocally.read();
    playerNameInput.addEventListener("change", ({ target: { value } }) => {
      playerNameStoredLocally.write(value);
    });

    const soundEffects = new Dialog(".js-dialog-sound-effects", {
      openingSelector: ".js-dialog-sound-effects-open",
      closingSelector: ".js-dialog-sound-effects-close",
      labelledby: "sound-effects-dialog-title",
    });
    Sounds.setSoundsPath("/assets/")
    Sounds.prepare("rain.mp3", { gain: 0.5 });
    Sounds.prepareAll([
      "suffle1.wav",
      "suffle2.wav",
      "play-card.wav",
      "deal-cards.wav",
      "suffle2.wav",
      "suffle2.wav",
    ]);

    for (let input of soundEffects.dialog.querySelectorAll(`input[type="checkbox"]`)) {
      input.addEventListener(
        "change",
        handleSoundEffectsChange
      );
    }

    const { href: link } = window.location;

    if (isVerifyLink(link)) {
      let email = authCompleteEmailStoredLocally.read();
      if (!email) {
        alert(
          "VypadÃ¡ to, Å¾e dokonÄujete ovÄ›Å™enÃ­ uÅ¾ivatele v jinÃ©m prohlÃ­Å¾eÄi neÅ¾ ve kterÃ©m jste zaÄali. "
        );
        email = window.prompt(
          `Pokud chcete pokraÄovat v tomto prohlÅ¾eÄi, vyplnÄ› svou email adresu znovu:`
        );
      }

      useVerifyLink(link, email).then(({ user }) => {
        if (user?.emailVerified) {
          history.pushState({}, "Noob", "/"); // todo back to game?
          authCompleteEmailStoredLocally.remove();
          handleUserVerifyChange(user);
        }
      });
    } else {
      currentUser().then(handleUserVerifyChange).catch(error => {
        if (confirm(`Chyba pÅ™i ovÄ›Å™ovÃ¡nÃ­ uÅ¾ivatele: ${error.message}. Zkusit naÄÃ­st znovu?`)) {
          window.location.reload();
        }
        console.error(error);
      });
    }

    const params = new URLSearchParams(window.location.search)
    if (params.has("game")) {
      handleGameStart({ gameId: params.get("game") }); // ğŸ‘Œ
    }


    function handleUserVerifyChange(user) {
      const isUserVerified = (user || undefined)?.emailVerified;

      for (let trigger of verifySelf.openingTriggers) {
        if (isUserVerified) trigger.setAttribute("aria-hidden", "true");
        else trigger.removeAttribute("aria-hidden");
      }

      for (let trigger of createGame.openingTriggers) {
        if (isUserVerified) trigger.removeAttribute("aria-hidden");
        else trigger.setAttribute("aria-hidden", "true");
      }
    };

    async function handleVerifySelfSubmit(event) {
      event.preventDefault();
      const { origin, search } = window.location;

      try {
        const backPath = new URLSearchParams(search).get('back');
        const formData = new FormData(event.target);

        const email = formData.get("email");
        const settings = {
          url: `${origin}${backPath || ''}`,
          handleCodeInApp: true,
        };

        await sendSignInLinkToEmail(auth, email, settings);
        authCompleteEmailStoredLocally.write(email);

        alert(`Odkaz pro pÅ™ihlÃ¡Å¡enÃ­ byl odeslÃ¡n na adresu ${email}.\n\nToto okno mÅ¯Å¾ete zavÅ™Ã­t.`);
      } catch (fok) {
        console.error(fok)
        alert(`Chyba pÅ™i odesÃ­lÃ¡nÃ­ odkazu: ${fok.message}. Zkuste to prosÃ­m znovu.`);
      }
    }

    async function handleCreateGameSubmit(event) {
      event.preventDefault();

      const submitButton = createGame.dialog.querySelector("button[type=submit]");
      const submitButtonLabel = submitButton.textContent;
      submitButton.setAttribute("disabled", "disabled");
      submitButton.textContent = 'VytvÃ¡Å™Ã­m hru...';

      try {
        const formData = new FormData(event.target);
        const payload = formDataToPayload(formData);
        const { data: { id: gameId } = {} } = await httpsCallable(fns, "createGame")(payload);

        if (!gameId) {
          alert("Hru se nepodaÅ™ilo vytvoÅ™it. Zkuste to prosÃ­m znovu.");
        } else {
          history.pushState({}, "Start Game", `/?game=${gameId}`);
          createGame.close();
          handleGameStart({ gameId }); // ğŸ‘Œ
        }
      } catch ({ message, code }) {
        if (code === "functions/permission-denied") {
          if (confirm("ZvlÃ¡Å¡tnÃ­, ale na toto nemÃ¡te prÃ¡vo. Zkuste naÄÃ­st strÃ¡nku znovu.")) {
            window.location.reload();
          }
        } else {
          alert(`Nastala chyba pÅ™i vytvÃ¡Å™enÃ­ hry.\n${message}`);
        }
      } finally {
        submitButton.removeAttribute("disabled");
        submitButton.textContent = submitButtonLabel;
      }
    }

    function handleSoundEffectsChange(event) {
      event.preventDefault();
      const { name, checked: enabled, type } = event.target;
      if (type !== "checkbox") throw new Error("Unexpected target type");
      switch (name) {
        case "music":
          Sounds.enable("rain.mp3", enabled, { autoplay: true, loop: true, gain: .4 });
          break;
        case "sounds":
          Sounds.enableAll([
            "suffle1.wav",
            "suffle2.wav",
            "play-card.wav",
            "deal-cards.wav",
            "suffle2.wav",
            "suffle2.wav",
          ], enabled);
          if (enabled) Sounds.play("play-card.wav");
          break;
        default:
          throw new Error("Unexpected name");
      }
    }

    function handleGameStart({ gameId }) {
      const [
        headerElement,
        contentElement
      ] = [".js-header", ".js-content"].map(s => document.querySelector(s));

      headerElement.firstElementChild.remove();
      contentElement.firstElementChild.remove();

      render(
        templates.header({}),
        headerElement
      );

      render(
        templates.content({ foo: "Meh." }),
        contentElement,
      );
    }


  </script>
</body>

</html>
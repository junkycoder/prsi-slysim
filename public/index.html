<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrÅ¡Ã­, slyÅ¡Ã­m!</title>
  <meta name="description"
    content="PrÅ¡Ã­, slyÅ¡Ã­m! - Online hra prÅ¡Ã­ pro vÃ­ce hrÃ¡ÄÅ¯, vytvoÅ™enÃ¡ primÃ¡rnÄ› pro uÅ¾ivatele se zrakovÃ½m handicapem.">
  <meta property="og:title" content="ZahrajeÅ¡ si prÅ¡Ã­?">
  <meta property="og:site_name" content="PrÅ¡Ã­, slyÅ¡Ã­m!">
  <meta property="og:url" content="https://prsi-slysim.web.app/">
  <meta property="og:description"
    content="Online hra prÅ¡Ã­ pro vÃ­ce hrÃ¡ÄÅ¯, vytvoÅ™enÃ¡ primÃ¡rnÄ› pro uÅ¾ivatele se zrakovÃ½m handicapem.">
  <meta property="og:type" content="website">
  <!-- <meta property="og:image" content=""> -->
  <style>
    [aria-hidden="true"] {
      display: none;
    }
  </style>
  <link rel="stylesheet" href="/styles.css">
</head>

<body>
  <div class="js-header">
    <header>
      <h1>PrÅ¡Ã­ slyÅ¡im!</h1>
      <p>Online hra prÅ¡Ã­ pro vÃ­ce hrÃ¡ÄÅ¯, vytvoÅ™enÃ¡ primÃ¡rnÄ› pro uÅ¾ivatele se zrakovÃ½m handicapem.</p>
    </header>
  </div>
  <div class="los-alertos"></div>
  <style>
    .los-alertos {
      position: absolute;
      top: 20px;
      left: 24px;
      right: 24px;
      z-index: 420;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .los-alertos__alerto {
      border-radius: 1px;
      padding: 14px;
      transition: opacity 200ms ease-in-out;
      opacity: 0;
      background-color: white;
      color: black;
      border: 5px solid black;
    }

    @media (prefers-color-scheme: dark) {
      .los-alertos__alerto {
        background-color: black;
        color: white;
        border-color: white;
      }
    }

    .los-alertos__alerto--show {
      opacity: 1;
    }
  </style>
  <script>
    window.alerto = function alerto(message) {
      const container = document.querySelector(".los-alertos");
      const time = Date.now();
      container.insertAdjacentHTML("afterbegin", `
        <div data-time="${time}" class="los-alertos__alerto" role="alert">
          ${message}
        </div>
      `);
      const element = container.querySelector(`.los-alertos__alerto[data-time="${time}"]`);
      const doRemove = () => {
        element.classList.remove("los-alertos__alerto--show");
        setInterval(() => {
          element.setAttribute("aria-hidden", "true");
          element.remove();
        }, 500);
      }
      element.addEventListener("click", doRemove);
      setTimeout(doRemove, 4000);
      setTimeout(() => {
        element.classList.add("los-alertos__alerto--show");
      }, 200);
    }
  </script>
  <div class="js-content">
    <main>
      <h2>KlasickÃ© prÅ¡Ã­</h2>
      <p>
        <em>PrÅ¡Ã­, slyÅ¡im!</em> vÃ¡m zprostÅ™edkuje zÃ¡Å¾itek z hranÃ­ bÄ›Å¾nÃ© karetnÃ­ hry
        <a href="https://cs.wikipedia.org/wiki/Pr%C5%A1%C3%AD" title="Wikipedie">prÅ¡Ã­</a>
        za pouÅ¾itÃ­ obyÄejnÃ©ho textu a akustickÃ½ch efektÅ¯.
      </p>
      <h2>ZvukovÃ© efekty</h2>
      <p>DoporuÄujeme hrÃ¡t na klidnÃ©m mÃ­stÄ› nebo/a se sluchÃ¡tky.</p>
      <!-- <p>Efekty je nejprve nutnÃ© zapnout.</p> -->
      <button class="js-dialog-sound-effects-open" type="button">Nastavit efekty</button>
      <section id="cta">
        <h2>Chci zaÄÃ­t hrÃ¡t</h2>
        <p class="js-dialog-verify-self-open">Pouze ovÄ›Å™enÃ­ uÅ¾ivatelÃ© se mouhou zapojit do hry.</p>
        <p class="js-dialog-create-game-open" aria-hidden="true">ZaloÅ¾te si svou vlastnÃ­ hru.</p>
        <button class="js-dialog-verify-self-open">OvÄ›Å™it se</button>
        <button aria-hidden="true" class="js-dialog-create-game-open">NovÃ¡ hra</button>
      </section>
      <section id="faq">
        <h2>Jak to funguje?</h2>
        <p>NÄ›kdo zaloÅ¾Ã­ novou hru.</p>
        <p>PotÃ© nasdÃ­li odkaz ostatnÃ­m hrÃ¡ÄÅ¯m.</p>
        <p>SpoluhrÃ¡Äi se pomocÃ­ odkazu zapojÃ­ do hry.</p>
        <p>PodmÃ­nka: Hry se mohou ÃºÄastnit pouze ovÄ›Å™enÃ­ uÅ¾ivatelÃ©.</p>
      </section>
      <section id="who">
        <h2>Kdo to udÄ›lal?</h2>
        <p>
          <a href="https://topmonks.com/" title="Software development partner for your business">TopMonks</a> &amp; <a
            href="http://isymbio.cz/" title="SYMBIO Access devices">SYMBIO</a>.
          JmenovitÄ› jÃ¡ (kÃ³d), TomÃ¡Å¡ FraÅˆek (smysl), Veronika HallerovÃ¡ (zvuk) a Jan FabiÃ¡n (hrÃ¡Ä).
        </p>
      </section>
      <section id="stats">
        <h2>Statistiky</h2>
        <p>
          K dneÅ¡nÃ­mu dni si 0 hrÃ¡ÄÅ¯ zahrÃ¡lo 0 her,
          probÄ›hlo celkem ~0 tahÅ¯.
        </p>
        <p>
          NejvÃ­ce vÃ½her mÃ¡ na svÃ©m kontÄ› Bude DoplnÄ›no,
          je to nejlepÅ¡Ã­ hrÃ¡Ä na svÄ›te!
        </p>
        <script type="module">
          const url = "https://firestore.googleapis.com/v1/projects/prsi-slysim/databases/(default)/documents/public/stats";
          const [firstLine, secondLine] = document.querySelectorAll("#stats p");

          fetch(url).then(r => r.json()).then(({ fields }) => {
            const { players, games, moves, winner } = fields;
            const score = winner.mapValue.fields;
            firstLine.textContent = `K dneÅ¡nÃ­mu dni si ${players.integerValue} uÅ¾ivatelÅ¯ zahrÃ¡lo ${games.integerValue} her, probÄ›hlo celkem ~${moves.integerValue} tahÅ¯.`;
            secondLine.textContent = `NejvÃ­ce her (${score.count.integerValue}) mÃ¡ na svÃ©m kontÄ› ${score.name.stringValue}, je to nejdelÅ¡Ã­ hrÃ¡Ä na svÄ›tÄ›!`;
          });
        </script>
      </section>
      <section id="copy">
        <p class="dimm" style="float: left">&copy; 02022.20</p>
        <p class="dimm" style="float: right">ğŸ¦ ,ğŸŒª, ğŸŒŠ, ğŸŒ‹, ğŸ‡ºğŸ‡¦, ...</p>
      </section>
    </main>
  </div>
  <div class="js-dialog-verify-self dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="verify-self-dialog-title">OvÄ›Å™it se pÅ™es email</h1>
        <p>Do hry se mohou zapojit pouze ovÄ›Å™enÃ­ uÅ¾ivatelÃ©. StaÄÃ­ k tomu vÅ¡ak obyÄejnÃ½ email.</p>
      </header>
      <form method="post" name="verify-self">
        <label for="email">VÃ¡Å¡ email:</label>
        <input type="email" id="email" name="email" placeholder="pepa@zdepa.cz" required>
        <p>Na uvedenou adresu vÃ¡m bude zaslÃ¡n odkaz pro pÅ™ihlÃ¡Å¡enÃ­.</p>
        <button type="submit">Odeslat</button>
        <button type="button" class="js-dialog-verify-self-close">ZavÅ™Ã­t</button>
      </form>
    </section>
  </div>
  <div class="js-dialog-create-game dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header class="dialog__header">
        <h1>NovÃ¡ hra</h1>
        <p>
          Zde mÅ¯Å¾ete zaloÅ¾it vlastnÃ­ hru.
        </p>
      </header>
      <form method="post" name="create-game">
        <label>
          <span>PoÄet CPU</span>
          <input type="number" name="cpu-players" min="0" max="2" value="0" />
        </label>
        <label>
          <span>PoÄet rozdanÃ½ch karet</span>
          <input type="number" name="dealed-cards" min="1" max="6" value="4" />
        </label>
        <label>
          <span>Max. poÄet hrÃ¡ÄÅ¯</span>
          <input type="number" name="max-players" min="2" max="8" value="4" />
        </label>
        <input type="hidden" name="id" />
        <button type="submit">VytvoÅ™it hru</button>
        <h2>Co bude dÃ¡l?</h2>
        <p>Po zaloÅ¾enÃ­ budete automaticky pÅ™ipojeni ke hÅ™e.</p>
        <p>
          PÅ™ed zahÃ¡jenÃ­m hry je potÅ™eba nasdÃ­let odkaz ostatnÃ­m spoluhrÃ¡ÄÅ¯m.
          Tento odkaz, s smoÅ¾nostÃ­ sdÃ­lÄ›nÃ­, vÃ¡m hra sama nabÃ­dne.
        </p>
        <p>Hru mÅ¯Å¾ete zaÄÃ­t jakmile se u stolu sejde dostateÄnÃ© mnoÅ¾stvÃ­ hrÃ¡ÄÅ¯.</p>
        <button type="button" class="js-dialog-create-game-close">ZavÅ™Ã­t</button>
      </form>
    </section>
  </div>
  <div class="js-dialog-sound-effects dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="sound-effects-dialog-title">ZvukovÃ© efekty</h1>
        <p>Zde mÅ¯Å¾ete vypnout vybranÃ© nebo veÅ¡kerÃ© zvuky hry.</p>
      </header>
      <p>
        <label class="flex">
          <input type="checkbox" name="music">
          <span>dÃ©Å¡Å¥ na pozadÃ­</span>
        </label>
      </p>
      <p>
        <label class="flex">
          <input type="checkbox" name="sounds" checked="checked">
          <span>zvuky karet</span>
        </label>
      </p>
      <button type="button" class="js-dialog-sound-effects-close">ZavÅ™Ã­t</button>
    </section>
  </div>
  <div class="js-dialog-join-game dialog" aria-hidden="true">
    <section class="dialog__inner">
      <header>
        <h1 id="join-game-dialog-title">Zapojit se do hry</h1>
        <p>... dokud je u stolu mÃ­sto.</p>
      </header>
      <form method="post" name="join-game">
        <label>
          <span>JmÃ©no vaÅ¡eho hrÃ¡Äe</span>
          <input type="text" name="player-name" required />
        </label>
        <button type="submit">Zapojit se</button>
        <button type="button" class="js-dialog-join-game-close">ZavÅ™Ã­t</button>
    </section>
  </div>
  <script type="module">
    window.addEventListener("resize", function syncHeight() {
      document.documentElement.style.setProperty(
        "--window-inner-height",
        `${window.innerHeight}px`
      );
    });
  </script>
  <script type="module">
    import Dialog, { setDefaults as setDialogDefaults } from "/library/a11y-dialog-component/esm.js";
    import { auth } from "/application.js";
    import { sendSignInLinkToEmail } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { authCompleteEmailStoredLocally } from "/storage.js";
    import { isVerifyLink, useVerifyLink, watchUser } from "/user.js";
    import { formDataToPayload, deepMerge } from "/library.js";
    import { httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-functions.js";
    import { playerNameStoredLocally } from "/storage.js";
    import { fns } from "/application.js";
    import { render } from "https://unpkg.com/lit-html@2.2.0/lit-html.js?module";
    import * as templates from "/templates.js";
    import Sounds, { toPositionInCircle } from "/sounds.js";
    import { db } from "/application.js";
    import { doc, onSnapshot, addDoc, collection, getDoc, } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getPlayer, CHANGE_CARD_VALUE } from "/library/prsi/index.js";
    import {
      SHUFFLE as SHUFFLE_MOVE,
      DRAW as DRAW_MOVE,
      PLAY as PLAY_MOVE,
      DEAL as DEAL_MOVE,
      STAY as STAY_MOVE,
    } from "/library/prsi/moves.js";

    const verifySelf = new Dialog(".js-dialog-verify-self", {
      openingSelector: ".js-dialog-verify-self-open",
      closingSelector: ".js-dialog-verify-self-close",
      labelledby: "verify-self-dialog-title",
    });

    verifySelf.dialog.querySelector("form").addEventListener(
      "submit",
      handleVerifySelfSubmit
    );

    const createGame = new Dialog(".js-dialog-create-game", {
      openingSelector: ".js-dialog-create-game-open",
      closingSelector: ".js-dialog-create-game-close",
      labelledby: "create-game-dialog-title",
    });

    createGame.dialog.querySelector("form").addEventListener(
      "submit",
      handleCreateGameSubmit
    );

    const soundEffects = new Dialog(".js-dialog-sound-effects", {
      openingSelector: ".js-dialog-sound-effects-open",
      closingSelector: ".js-dialog-sound-effects-close",
      labelledby: "sound-effects-dialog-title",
    });
    Sounds.setSoundsPath("/assets/")

    const MOVE_EFFECTS = {
      default: "deck.wav",
      [SHUFFLE_MOVE]: "shuffle1.wav", // "shuffle2.wav",
      [PLAY_MOVE]: "play-card.wav",
      [DEAL_MOVE]: "deal-cards.wav",
      [DRAW_MOVE]: "draw.wav",
      // [STAY_MOVE]: "stay.wav",
    };


    for (let input of soundEffects.dialog.querySelectorAll(`input[type="checkbox"]`)) {
      input.addEventListener(
        "change",
        handleSoundEffectsChange
      );
    }

    const joinGame = new Dialog(".js-dialog-join-game", {
      openingSelector: ".js-dialog-join-game-open",
      closingSelector: ".js-dialog-join-game-close",
      labelledby: "join-game-dialog-title",
    });

    const playerNameInput = joinGame.dialog.querySelector(`form input[name="player-name"]`);
    playerNameInput.value = playerNameStoredLocally.read();
    playerNameInput.addEventListener("change", ({ target: { value } }) => {
      playerNameStoredLocally.write(value);
    });

    USER: {
      watchUser(handleUserVerifyChange);
    }

    GAME: {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has("game")) {
        handleGamePlay(urlParams.get("game")); // Existing game ENTRY POINT
      }
    }


    function handleUserVerifyChange(user) {
      const isUserVerified = (user || undefined)?.emailVerified;
      const { href: link } = window.location;

      if (!isUserVerified && isVerifyLink(link)) {
        let email = authCompleteEmailStoredLocally.read();
        if (!email) {
          alert(
            "VypadÃ¡ to, Å¾e dokonÄujete ovÄ›Å™enÃ­ uÅ¾ivatele v jinÃ©m prohlÃ­Å¾eÄi neÅ¾ ve kterÃ©m jste zaÄali. "
          );
          email = window.prompt(
            `Pokud chcete pokraÄovat v tomto prohlÅ¾eÄi, vyplnÄ› svou email adresu znovu:`
          );
        }

        useVerifyLink(link, email).then(({ user: u }) => {
          const urlParams = new URLSearchParams(window.location.search);
          history.pushState({}, "Verified", urlParams.has("game") ? `/?game=${urlParams.get("game")}` : "/");
          handleUserVerifyChange(u);
        });
      }

      for (let trigger of verifySelf.openingTriggers) {
        if (isUserVerified) trigger.setAttribute("aria-hidden", "true");
        else trigger.removeAttribute("aria-hidden");
      }

      for (let trigger of createGame.openingTriggers) {
        if (isUserVerified) trigger.removeAttribute("aria-hidden");
        else trigger.setAttribute("aria-hidden", "true");
      }
    };

    async function handleVerifySelfSubmit(event) {
      event.preventDefault();
      const { origin, search } = window.location;

      const submitButton = verifySelf.dialog.querySelector("form button[type=submit]");
      const submitButtonLabel = submitButton.textContent;
      submitButton.setAttribute("disabled", "disabled");
      submitButton.textContent = "OdesÃ­lÃ¡m";

      try {
        const formData = new FormData(event.target);
        const urlParams = new URLSearchParams(window.location.search);
        const email = formData.get("email");
        const settings = {
          url: `${origin}${urlParams.has("game") ? `?game=${urlParams.get("game")}` : ""}`,
          handleCodeInApp: true,
        };

        await sendSignInLinkToEmail(auth, email, settings);
        authCompleteEmailStoredLocally.write(email);

        submitButton.textContent = "OdeslÃ¡no";
        alert(`OdeslÃ¡no, pokraÄujte prosÃ­m do vaÅ¡Ã­ ${email} schrÃ¡nky.\n\Tuto strÃ¡nku mÅ¯Å¾ete zavÅ™Ã­t.`);
        setTimeout(() => {
          submitButton.textContent = submitButtonLabel;
          submitButton.removeAttribute("disabled");
        }, 5000);
      } catch (fok) {
        console.error(fok)
        alert(`Chyba pÅ™i odesÃ­lÃ¡nÃ­ odkazu: ${fok.message}. Zkuste to prosÃ­m znovu.`);
        submitButton.removeAttribute("disabled");
        submitButton.textContent = submitButtonLabel;
      }
    }

    async function handleCreateGameSubmit(event) {
      event.preventDefault();

      const submitButton = createGame.dialog.querySelector("button[type=submit]");
      const submitButtonLabel = submitButton.textContent;
      submitButton.setAttribute("disabled", "disabled");
      submitButton.textContent = "VytvÃ¡Å™Ã­m hru";

      try {
        const formData = new FormData(event.target);
        const payload = formDataToPayload(formData);
        const { data: { id: gameId } = {} } = await httpsCallable(fns, "createGame")(payload);

        if (!gameId) {
          alert("Hru se nepodaÅ™ilo vytvoÅ™it. Zkuste to prosÃ­m znovu.");
        } else {
          history.pushState({}, "New Game", `/?game=${gameId}`);
          handleGamePlay(gameId); // ğŸ‘Œ New Game ENTRYPOINT
          createGame.close();
        }
      } catch ({ message, code }) {
        if (code === "functions/permission-denied") {
          if (confirm("ZvlÃ¡Å¡tnÃ­, ale na toto nemÃ¡te prÃ¡vo. Zkuste naÄÃ­st strÃ¡nku znovu.")) {
            window.location.reload();
          }
        } else {
          alert(`Nastala chyba pÅ™i vytvÃ¡Å™enÃ­ hry.\n${message}`);
        }
      } finally {
        submitButton.removeAttribute("disabled");
        submitButton.textContent = submitButtonLabel;
      }
    }

    function handleSoundEffectsChange(event) {
      event.preventDefault();
      const { name, checked: enabled, type } = event.target;
      if (type !== "checkbox") throw new Error("Unexpected target type");
      switch (name) {
        case "music":
          Sounds.enable("rain.mp3", enabled, { autoplay: true, loop: true, gain: .4 });
          break;
        case "sounds":
          Sounds.enableAll(Object.values(MOVE_EFFECTS), enabled);
          if (enabled) Sounds.play(MOVE_EFFECTS.default);
          break;
        default:
          throw new Error("Unexpected sound effect name");
      }
    }

    function handleGamePlay(gameId) {
      console.info("Game play", gameId);
      const [
        headerElement,
        contentElement
      ] = [".js-header", ".js-content"].map(s => document.querySelector(s));

      clearStaticPage: {
        headerElement.firstElementChild.remove();
        contentElement.firstElementChild.remove();
        window.scrollTo(0, 0);
      }

      let state = {
        game: undefined,
        user: null,
        selectedCard: undefined,
        selectedColor: undefined,
      };


      joinGame.dialog.querySelector("form").addEventListener(
        "submit",
        async (event) => {
          const game = await handleJoinGameSubmit(event);
          if (game) {
            emit({ game });
            Sounds.enableAll(Object.values(MOVE_EFFECTS), true);
            Sounds.play(MOVE_EFFECTS.default);
          }
        }
      );

      watchUser((u) => {
        emit({ user: u?.toJSON() });
      });

      const handlers = {
        handleLeaveGame() {
          window.location.href = "/";
        },
        handleShareGame(event) {
          event.preventDefault();
          const shateLink = window.location.href;
          const shareText = `Hra je zaloÅ¾enÃ¡, staÄÃ­ se pÅ™ipojit..`;

          if (navigator.share) {
            navigator.share({
              text: shareText,
              url: shateLink
            });
          } else {
            navigator.clipboard
              .writeText(`${shateLink} ${shareText}`)
              .then(() => alert("Odkaz na hru byl zkopÃ­rovÃ¡n do schrÃ¡nky."))
          }
        },
        async handleMove(event) {
          const urlParams = new URLSearchParams(window.location.search);
          const gameId = urlParams.get("game");

          const buttonElement = event.target;
          const { name: moveType } = buttonElement;

          try {
            emit({ busy: moveType });

            await Sounds.playTimes(
              MOVE_EFFECTS[moveType] || MOVE_EFFECTS.default,
              buttonElement.dataset.n || 1
            ).catch(O_o => console.error(O_o));

            const { data: { game } } = await httpsCallable(fns, "gameMove")({
              moveType,
              gameId,
              card: state.selectedCard,
              color: state.selectedColor,
            });

            emit({
              game,
              // cleanup ui controls
              selectedCard: null,
              selectedColor: null,
            });

          } catch (error) {
            console.error(error);
            // â€¼ï¸ even server error will tell it is wrong move.
            alert("Å patnÃ½ tah.");
          } finally {
            emit({ busy: null });
          }
        },
        handlePlayerCardSelect(event) {
          const cardId = event.target.value;
          const player = getPlayer(state.game, state.user.uid);
          const { value, color, id } = player.cards.find(card => card.id === cardId);
          const makeMoveButtonElement = document.querySelector(`button[name="${PLAY_MOVE}"]`);

          if (value === CHANGE_CARD_VALUE) {
            emit({
              selectedCard: { value, color, id },
              selectedColor: color
            });
          } else {
            emit({ selectedCard: { value, color, id } });
          }
          makeMoveButtonElement.focus();
        },
        handleCardColorSelect(event) {
          const makeMoveButtonElement = document.querySelector(`button[name="${PLAY_MOVE}"]`);
          const color = event.target.value;
          emit({ selectedColor: color });
          makeMoveButtonElement.focus();
        },
        // ...
      };

      function emit(payload = {}) {
        state = deepMerge(state, payload);

        render(
          templates.header(state, handlers),
          headerElement
        );
        render(
          templates.content(state, handlers),
          contentElement,
        );
        window.debug = state;
      }


      const queryToPublicCopy = () => `play/public/game/${gameId}`;
      const queryToPlayerCopy = () => `play/${state.user?.uid}/game/${gameId}`;

      // Firstly using public copy, then, once user joins the game we start using private copy
      let usedCopyQuery = queryToPublicCopy();
      const unsubcribePublicCopy = onSnapshot(doc(db, usedCopyQuery), handleSnapshot);

      function handleSnapshot(d) {
        const game = d.data();

        // Uplne inak todleto, predbiha se to, neni to spolehlivy a tak.
        // if (
        //   game.lastMove &&
        //   game.lastMove.type !== state.game?.lastMove?.type &&
        //   game.lastMove?.player.id !== state.user?.uid
        // ) {
        if (
          state.game &&
          game.lastMove && // je to update stavu hry
          game.lastMove.player.id !== state.user?.uid && // nejsem to jÃ¡
          (
            // a neni to stejnÃ½ tah jako pÅ™edchozÃ­
            game.lastMove.player.id !== state.game.lastMove?.player.id ||
            game.lastMove.type !== state.game.lastMove.type
          )
        ) {
          setTimeout(() => {
            alerto(templates.moveMessage(game, state.user));
            playPlayerMoveEffects(game.lastMove, game.players, game.settings);
          }, 0);
        }

        if (
          state.user?.uid &&
          usedCopyQuery === queryToPublicCopy() &&
          getPlayer(game, state.user?.uid)
        ) {
          usedCopyQuery = queryToPlayerCopy();
          console.info("Switching to private copy", usedCopyQuery);
          unsubcribePublicCopy();
          onSnapshot(doc(db, usedCopyQuery), handleSnapshot);
        } else {
          try {
            emit({ game });
          } catch (e) {
            debugger;
          }
        }
      }


      function playPlayerMoveEffects(lastMove, players = [], settings = {}) {
        const sound = MOVE_EFFECTS[lastMove.type] || MOVE_EFFECTS.default;
        const position = toPositionInCircle({
          index: players.findIndex(player => player.id === lastMove.player.id),
          length: players.length,
        });

        if (lastMove.type === SHUFFLE_MOVE) {
          Sounds.playTimes(sound, settings.dealCards, {
            position,
          });
        } else if (lastMove.type === DRAW_MOVE) {
          Sounds.playTimes(sound, lastMove.drawn, {
            position,
          });
        } else {
          Sounds.play(sound, { position });
        }
      }

    }

    async function handleJoinGameSubmit(event) {
      console.warn("TODO: allow only one same player name in the game, remove playerId from public game events then")
      event.preventDefault();
      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get("game");

      for (let trigger of joinGame.openingTriggers) {
        trigger.setAttribute("disabled", "disabled");
      }

      const submitButton = joinGame.dialog.querySelector("button[type=submit]");
      const submitButtonLabel = submitButton.textContent;
      submitButton.setAttribute("disabled", "disabled");
      submitButton.textContent = "PÅ™isedÃ¡m";

      if (!gameId) {
        console.error("Game ID not found");
        if (confirm("Ztratilo se ID hry. Budete pÅ™esmÄ›rovÃ¡ni na hlavnÃ­ strÃ¡nku.")) {
          window.location.href = "/";
        }
        return;
      }

      const formData = new FormData(event.target);
      const playerName = formData.get("player-name");

      try {
        const { data: { game } = {} } = await httpsCallable(fns, "joinGame")({ playerName, gameId });
        submitButton.removeAttribute("disabled");
        submitButton.textContent = submitButtonLabel;
        joinGame.close();
        return game;
      } catch (error) {
        if (error.code === "already-exists") {
          alert(`${playerName} jiÅ¾ hraje v tÃ©to hÅ™e.`);
        } else {
          alert(`Nastala chyba pÅ™i pÅ™ipojovÃ¡nÃ­ k hÅ™e: ${error.message}`);
        }
      }
    }

  </script>
</body>

</html>